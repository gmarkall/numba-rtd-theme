

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>7.6. Notes on Numba Runtime &mdash; Numba 0.49.0dev0+636.ga4807f5d8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/numba-blue-icon-rgb.svg"/>
  
  
  
    <link rel="canonical" href="http://numba.pydata.org/numba-doc/latest/index.htmldeveloper/numba-runtime.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7.7. Using the Numba Rewrite Pass for Fun and Optimization" href="rewrites.html" />
    <link rel="prev" title="7.5. Notes on generators" href="generators.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Numba
          

          
            
            <img src="../_static/numba-blue-icon-rgb.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.49
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">7. Developer Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="contributing.html">7.1. Contributing to Numba</a></li>
<li class="toctree-l2"><a class="reference internal" href="repomap.html">7.2. A Map of the Numba Repository</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">7.3. Numba architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="dispatching.html">7.4. Polymorphic dispatching</a></li>
<li class="toctree-l2"><a class="reference internal" href="generators.html">7.5. Notes on generators</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">7.6. Notes on Numba Runtime</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#memory-management">7.6.1. Memory Management</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cooperating-with-cpython">7.6.1.1. Cooperating with CPython</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiler-side-cooperation">7.6.1.2. Compiler-side Cooperation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#optimizations">7.6.1.3. Optimizations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#quirks">7.6.1.4. Quirks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-leaks">7.6.1.5. Debugging Leaks</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging-leaks-in-c">7.6.1.6. Debugging Leaks in C</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#recursion-support">7.6.2. Recursion Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-the-nrt-from-c-code">7.6.3. Using the NRT from C code</a></li>
<li class="toctree-l3"><a class="reference internal" href="#future-plan">7.6.4. Future Plan</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rewrites.html">7.7. Using the Numba Rewrite Pass for Fun and Optimization</a></li>
<li class="toctree-l2"><a class="reference internal" href="live_variable_analysis.html">7.8. Live Variable Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="listings.html">7.9. Listings</a></li>
<li class="toctree-l2"><a class="reference internal" href="stencil.html">7.10. Notes on stencils</a></li>
<li class="toctree-l2"><a class="reference internal" href="custom_pipeline.html">7.11. Customizing the Compiler</a></li>
<li class="toctree-l2"><a class="reference internal" href="inlining.html">7.12. Notes on Inlining</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment.html">7.13. Environment Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="hashing.html">7.14. Notes on Hashing</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">7.15. Notes on Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="threading_implementation.html">7.16. Notes on Numba’s threading implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="literal.html">7.17. Notes on Literal Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">7.18. Notes on Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html">7.19. Numba Project Roadmap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Numba</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">7. Developer Manual</a> &raquo;</li>
        
      <li>7.6. Notes on Numba Runtime</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/developer/numba-runtime.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="notes-on-numba-runtime">
<span id="arch-numba-runtime"></span><h1>7.6. Notes on Numba Runtime<a class="headerlink" href="#notes-on-numba-runtime" title="Permalink to this headline">¶</a></h1>
<p>The <em>Numba Runtime (NRT)</em> provides the language runtime to the <em>nopython mode</em>
Python subset.  NRT is a standalone C library with a Python binding.  This
allows NPM runtime feature to be used without the GIL.  Currently, the only
language feature implemented in NRT is memory management.</p>
<div class="section" id="memory-management">
<h2>7.6.1. Memory Management<a class="headerlink" href="#memory-management" title="Permalink to this headline">¶</a></h2>
<p>NRT implements memory management for NPM code.  It uses <em>atomic reference count</em>
for threadsafe, deterministic memory management.  NRT maintains a separate
<code class="docutils literal notranslate"><span class="pre">MemInfo</span></code> structure for storing information about each allocation.</p>
<div class="section" id="cooperating-with-cpython">
<h3>7.6.1.1. Cooperating with CPython<a class="headerlink" href="#cooperating-with-cpython" title="Permalink to this headline">¶</a></h3>
<p>For NRT to cooperate with CPython, the NRT python binding provides adaptors for
converting python objects that export a memory region.  When such an
object is used as an argument to a NPM function, a new <code class="docutils literal notranslate"><span class="pre">MemInfo</span></code> is created
and it acquires a reference to the Python object.  When a NPM value is returned
to the Python interpreter, the associated <code class="docutils literal notranslate"><span class="pre">MemInfo</span></code> (if any) is checked.  If
the <code class="docutils literal notranslate"><span class="pre">MemInfo</span></code> references a Python object, the underlying Python object is
released and returned instead.  Otherwise, the <code class="docutils literal notranslate"><span class="pre">MemInfo</span></code> is wrapped in a
Python object and returned.  Additional process maybe required depending on
the type.</p>
<p>The current implementation supports Numpy array and any buffer-exporting types.</p>
</div>
<div class="section" id="compiler-side-cooperation">
<h3>7.6.1.2. Compiler-side Cooperation<a class="headerlink" href="#compiler-side-cooperation" title="Permalink to this headline">¶</a></h3>
<p>NRT reference counting requires the compiler to emit incref/decref operations
according to the usage.  When the reference count drops to zero, the compiler
must call the destructor routine in NRT.</p>
</div>
<div class="section" id="optimizations">
<span id="nrt-refct-opt-pass"></span><h3>7.6.1.3. Optimizations<a class="headerlink" href="#optimizations" title="Permalink to this headline">¶</a></h3>
<p>The compiler is allowed to emit incref/decref operations naively.  It relies
on an optimization pass that to remove the redundant reference count
operations.</p>
<p>The optimization pass runs on block level to avoid control flow analysis.
It depends on LLVM function optimization pass to simplify the control flow,
stack-to-register, and simplify instructions.  It works by matching and
removing incref and decref pairs within each block.</p>
</div>
<div class="section" id="quirks">
<h3>7.6.1.4. Quirks<a class="headerlink" href="#quirks" title="Permalink to this headline">¶</a></h3>
<p>Since the <a class="reference internal" href="#nrt-refct-opt-pass">refcount optimization pass</a> requires LLVM
function optimization pass, the pass works on the LLVM IR as text.  The
optimized IR is then materialized again as a new LLVM in-memory bitcode object.</p>
</div>
<div class="section" id="debugging-leaks">
<h3>7.6.1.5. Debugging Leaks<a class="headerlink" href="#debugging-leaks" title="Permalink to this headline">¶</a></h3>
<p>To debug reference leaks in NRT MemInfo, each MemInfo python object has a
<code class="docutils literal notranslate"><span class="pre">.refcount</span></code> attribute for inspection.  To get the MemInfo from a ndarray
allocated by NRT, use the <code class="docutils literal notranslate"><span class="pre">.base</span></code> attribute.</p>
<p>To debug memory leaks in NRT, the <code class="docutils literal notranslate"><span class="pre">numba.runtime.rtsys</span></code> defines
<code class="docutils literal notranslate"><span class="pre">.get_allocation_stats()</span></code>.  It returns a namedtuple containing the
number of allocation and deallocation since the start of the program.
Checking that the allocation and deallocation counters are matching is the
simplest way to know if the NRT is leaking.</p>
</div>
<div class="section" id="debugging-leaks-in-c">
<h3>7.6.1.6. Debugging Leaks in C<a class="headerlink" href="#debugging-leaks-in-c" title="Permalink to this headline">¶</a></h3>
<p>The start of <a class="reference external" href="https://github.com/numba/numba/blob/master/numba/runtime/nrt.h">numba/runtime/nrt.h</a>
has these lines:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cm">/* Debugging facilities - enabled at compile-time */</span>
<span class="cm">/* #undef NDEBUG */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#   define NRT_Debug(X) X</span>
<span class="cp">#else</span>
<span class="cp">#   define NRT_Debug(X) if (0) { X; }</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>Undefining NDEBUG (uncomment the <code class="docutils literal notranslate"><span class="pre">#undef</span> <span class="pre">NDEBUG</span></code> line) enables the assertion
check in NRT.</p>
<p>Enabling the NRT_Debug (replace <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">0</span></code> with <code class="docutils literal notranslate"><span class="pre">#if</span> <span class="pre">1</span></code>) turns on
debug print inside NRT.</p>
</div>
</div>
<div class="section" id="recursion-support">
<h2>7.6.2. Recursion Support<a class="headerlink" href="#recursion-support" title="Permalink to this headline">¶</a></h2>
<p>During the compilation of a pair of mutually recursive functions, one of the
functions will contain unresolved symbol references since the compiler handles
one function at a time.  The memory for the unresolved symbols is allocated and
initialized to the address of the <em>unresolved symbol abort</em> function
(<code class="docutils literal notranslate"><span class="pre">nrt_unresolved_abort</span></code>) just before the machine code is
generated by LLVM.  These symbols are tracked and resolved as new functions are
compiled.  If a bug prevents the resolution of these symbols,
the abort function will be called, raising a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code> exception.</p>
<p>The <em>unresolved symbol abort</em> function is defined in the NRT with a zero-argument
signature. The caller is safe to call it with arbitrary number of
arguments.  Therefore, it is safe to be used inplace of the intended callee.</p>
</div>
<div class="section" id="using-the-nrt-from-c-code">
<h2>7.6.3. Using the NRT from C code<a class="headerlink" href="#using-the-nrt-from-c-code" title="Permalink to this headline">¶</a></h2>
<p>Externally compiled C code should use the <code class="docutils literal notranslate"><span class="pre">NRT_api_functions</span></code> struct as a
function table to access the NRT API. The struct is defined in
<a class="reference external" href="https://www.github.com/numba/numba/blob/master/numba/core/runtime/nrt_external.h">numba/core/runtime/nrt_external.h</a>. Users can use the utility function
<code class="docutils literal notranslate"><span class="pre">numba.extending.include_path()</span></code> to determine the include directory for
Numba provided C headers.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><cite>numba/core/runtime/nrt_external.h</cite></span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef NUMBA_NRT_EXTERNAL_H_</span>
<span class="cp">#define NUMBA_NRT_EXTERNAL_H_</span>

<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">MemInfo</span> <span class="n">NRT_MemInfo</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="nf">NRT_managed_dtor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="cm">/* Methods to create MemInfos.</span>

<span class="cm">    MemInfos are like smart pointers for objects that are managed by the Numba.</span>
<span class="cm">    */</span>

    <span class="cm">/* Allocate memory</span>

<span class="cm">    *nbytes* is the number of bytes to be allocated</span>

<span class="cm">    Returning a new reference.</span>
<span class="cm">    */</span>
    <span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">allocate</span><span class="p">)(</span><span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>

    <span class="cm">/* Convert externally allocated memory into a MemInfo.</span>

<span class="cm">    *data* is the memory pointer</span>
<span class="cm">    *dtor* is the deallocator of the memory</span>
<span class="cm">    */</span>
    <span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">manage_memory</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">NRT_managed_dtor</span> <span class="n">dtor</span><span class="p">);</span>

    <span class="cm">/* Acquire a reference */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">acquire</span><span class="p">)(</span><span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="n">mi</span><span class="p">);</span>

    <span class="cm">/* Release a reference */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">release</span><span class="p">)(</span><span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="n">mi</span><span class="p">);</span>

    <span class="cm">/* Get MemInfo data pointer */</span>
    <span class="kt">void</span><span class="o">*</span> <span class="p">(</span><span class="o">*</span><span class="n">get_data</span><span class="p">)(</span><span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="n">mi</span><span class="p">);</span>

<span class="p">}</span> <span class="n">NRT_api_functions</span><span class="p">;</span>



<span class="cp">#endif </span><span class="cm">/* NUMBA_NRT_EXTERNAL_H_ */</span><span class="cp"></span>
</pre></div>
</div>
</div>
<p>Inside Numba compiled code, the <code class="docutils literal notranslate"><span class="pre">numba.core.unsafe.nrt.NRT_get_api()</span></code>
intrinsic can be used to obtain a pointer to the <code class="docutils literal notranslate"><span class="pre">NRT_api_functions</span></code>.</p>
<p>Here is an example that uses the <code class="docutils literal notranslate"><span class="pre">nrt_external.h</span></code>:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;numba/core/runtime/nrt_external.h&quot;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">my_dtor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">free</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">NRT_MemInfo</span><span class="o">*</span> <span class="nf">my_allocate</span><span class="p">(</span><span class="n">NRT_api_functions</span> <span class="o">*</span><span class="n">nrt</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* heap allocate some memory */</span>
    <span class="kt">void</span> <span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="cm">/* wrap the allocated memory; yield a new reference */</span>
    <span class="n">NRT_MemInfo</span> <span class="o">*</span><span class="n">mi</span> <span class="o">=</span> <span class="n">nrt</span><span class="o">-&gt;</span><span class="n">manage_memory</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">my_dtor</span><span class="p">);</span>
    <span class="cm">/* acquire reference */</span>
    <span class="n">nrt</span><span class="o">-&gt;</span><span class="n">acquire</span><span class="p">(</span><span class="n">mi</span><span class="p">);</span>
    <span class="cm">/* release reference */</span>
    <span class="n">nrt</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">mi</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">mi</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="future-plan">
<h2>7.6.4. Future Plan<a class="headerlink" href="#future-plan" title="Permalink to this headline">¶</a></h2>
<p>The plan for NRT is to make a standalone shared library that can be linked to
Numba compiled code, including use within the Python interpreter and without
the Python interpreter.  To make that work, we will be doing some refactoring:</p>
<ul class="simple">
<li><p>numba NPM code references statically compiled code in “helperlib.c”.  Those
functions should be moved to NRT.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rewrites.html" class="btn btn-neutral float-right" title="7.7. Using the Numba Rewrite Pass for Fun and Optimization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="generators.html" class="btn btn-neutral float-left" title="7.5. Notes on generators" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2020, Anaconda, Inc. and others

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>