

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.15. The Threading Layers &mdash; Numba 0.49.0dev0+637.g3a659b257 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/numba-blue-icon-rgb.svg"/>
  
  
  
    <link rel="canonical" href="http://numba.pydata.org/numba-doc/latest/index.htmluser/threading-layer.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1.16. Command line interface" href="cli.html" />
    <link rel="prev" title="1.14. Performance Tips" href="performance-tips.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #00A3E0" >
          

          
            <a href="../index.html" class="icon icon-home"> Numba
          

          
            
            <img src="../_static/numba-white-icon-rgb.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.49
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">1. User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="5minguide.html">1.1. A ~5 minute guide to Numba</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html">1.2. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing.html">1.3. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="jit.html">1.4. Compiling Python code with <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="generated-jit.html">1.5. Flexible specializations with <code class="docutils literal notranslate"><span class="pre">&#64;generated_jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="vectorize.html">1.6. Creating Numpy universal functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="jitclass.html">1.7. Compiling Python classes with <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cfunc.html">1.8. Creating C callbacks with <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="pycc.html">1.9. Compiling code ahead of time</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel.html">1.10. Automatic parallelization with <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="stencil.html">1.11. Using the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator</a></li>
<li class="toctree-l2"><a class="reference internal" href="withobjmode.html">1.12. Callback into the Python Interpreter from within JIT’ed code</a></li>
<li class="toctree-l2"><a class="reference internal" href="jit-module.html">1.13. Automatic module jitting with <code class="docutils literal notranslate"><span class="pre">jit_module</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="performance-tips.html">1.14. Performance Tips</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.15. The Threading Layers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#which-threading-layers-are-available">1.15.1. Which threading layers are available?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-threading-layer">1.15.2. Setting the threading layer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#selecting-a-threading-layer-for-safe-parallel-execution">1.15.2.1. Selecting a threading layer for safe parallel execution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selecting-a-named-threading-layer">1.15.2.2. Selecting a named threading layer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#extra-notes">1.15.3. Extra notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-number-of-threads">1.15.4. Setting the Number of Threads</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-of-limiting-the-number-of-threads">1.15.4.1. Example of Limiting the Number of Threads</a></li>
<li class="toctree-l4"><a class="reference internal" href="#api-reference">1.15.4.2. API Reference</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cli.html">1.16. Command line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshoot.html">1.17. Troubleshooting and tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html">1.18. Frequently Asked Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">1.19. Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="talks.html">1.20. Talks and Tutorials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Numba</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">1. User Manual</a> &raquo;</li>
        
      <li>1.15. The Threading Layers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/user/threading-layer.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-threading-layers">
<span id="numba-threading-layer"></span><h1>1.15. The Threading Layers<a class="headerlink" href="#the-threading-layers" title="Permalink to this headline">¶</a></h1>
<p>This section is about the Numba threading layer, this is the library that is
used internally to perform the parallel execution that occurs through the use of
the <code class="docutils literal notranslate"><span class="pre">parallel</span></code> targets for CPUs, namely:</p>
<ul class="simple">
<li><p>The use of the <code class="docutils literal notranslate"><span class="pre">parallel=True</span></code> kwarg in <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;njit</span></code>.</p></li>
<li><p>The use of the <code class="docutils literal notranslate"><span class="pre">target='parallel'</span></code> kwarg in <code class="docutils literal notranslate"><span class="pre">&#64;vectorize</span></code> and
<code class="docutils literal notranslate"><span class="pre">&#64;guvectorize</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a code base does not use the <code class="docutils literal notranslate"><span class="pre">threading</span></code> or <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>
modules (or any other sort of parallelism) the defaults for the threading
layer that ship with Numba will work well, no further action is required!</p>
</div>
<div class="section" id="which-threading-layers-are-available">
<h2>1.15.1. Which threading layers are available?<a class="headerlink" href="#which-threading-layers-are-available" title="Permalink to this headline">¶</a></h2>
<p>There are three threading layers available and they are named as follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">tbb</span></code> - A threading layer backed by Intel TBB.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">omp</span></code> - A threading layer backed by OpenMP.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">workqueue</span></code> -A simple built-in work-sharing task scheduler.</p></li>
</ul>
<p>In practice, the only threading layer guaranteed to be present is <code class="docutils literal notranslate"><span class="pre">workqueue</span></code>.
The <code class="docutils literal notranslate"><span class="pre">omp</span></code> layer requires the presence of a suitable OpenMP runtime library.
The <code class="docutils literal notranslate"><span class="pre">tbb</span></code> layer requires the presence of Intel’s TBB libraries, these can be
obtained via the conda command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ conda install tbb
</pre></div>
</div>
<p>If you installed Numba with <code class="docutils literal notranslate"><span class="pre">pip</span></code>, TBB can be enabled by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install tbb
</pre></div>
</div>
<p>Due to compatibility issues with manylinux1 and other portability concerns,
the OpenMP threading layer is disabled in the Numba binary wheels on PyPI.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default manner in which Numba searches for and loads a threading layer
is tolerant of missing libraries, incompatible runtimes etc.</p>
</div>
</div>
<div class="section" id="setting-the-threading-layer">
<span id="numba-threading-layer-setting-mech"></span><h2>1.15.2. Setting the threading layer<a class="headerlink" href="#setting-the-threading-layer" title="Permalink to this headline">¶</a></h2>
<p>The threading layer is set via the environment variable
<code class="docutils literal notranslate"><span class="pre">NUMBA_THREADING_LAYER</span></code> or through assignment to
<code class="docutils literal notranslate"><span class="pre">numba.config.THREADING_LAYER</span></code>. If the programmatic approach to setting the
threading layer is used it must occur logically before any Numba based
compilation for a parallel target has occurred. There are two approaches to
choosing a threading layer, the first is by selecting a threading layer that is
safe under various forms of parallel execution, the second is through explicit
selection via the threading layer name (e.g. <code class="docutils literal notranslate"><span class="pre">tbb</span></code>).</p>
<div class="section" id="selecting-a-threading-layer-for-safe-parallel-execution">
<h3>1.15.2.1. Selecting a threading layer for safe parallel execution<a class="headerlink" href="#selecting-a-threading-layer-for-safe-parallel-execution" title="Permalink to this headline">¶</a></h3>
<p>Parallel execution is fundamentally derived from core Python libraries in four
forms (the first three also apply to code using parallel execution via other
means!):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">threads</span></code> from the <code class="docutils literal notranslate"><span class="pre">threading</span></code> module.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">spawn</span></code> ing processes from the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module via <code class="docutils literal notranslate"><span class="pre">spawn</span></code>
(default on Windows, only available in Python 3.4+ on Unix)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fork</span></code> ing processes from the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module via <code class="docutils literal notranslate"><span class="pre">fork</span></code>
(default on Unix).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fork</span></code> ing processes from the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> module through the use of
a <code class="docutils literal notranslate"><span class="pre">forkserver</span></code> (only available in Python 3 on Unix). Essentially a new
process is spawned and then forks are made from this new process on request.</p></li>
</ul>
<p>Any library in use with these forms of parallelism must exhibit safe behaviour
under the given paradigm. As a result, the threading layer selection methods
are designed to provide a way to choose a threading layer library that is safe
for a given paradigm in an easy, cross platform and environment tolerant manner.
The options that can be supplied to the
<a class="reference internal" href="#numba-threading-layer-setting-mech"><span class="std std-ref">setting mechanisms</span></a> are as
follows:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">default</span></code> provides no specific safety guarantee and is the default.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">safe</span></code> is both fork and thread safe, this requires the <code class="docutils literal notranslate"><span class="pre">tbb</span></code> package
(Intel TBB libraries) to be installed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forksafe</span></code> provides a fork safe library.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">threadsafe</span></code> provides a thread safe library.</p></li>
</ul>
<p>To discover the threading layer that was selected, the function
<code class="docutils literal notranslate"><span class="pre">numba.threading_layer()</span></code> may be called after parallel execution. For example,
on a Linux machine with no TBB installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">config</span><span class="p">,</span> <span class="n">njit</span><span class="p">,</span> <span class="n">threading_layer</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># set the threading layer before any parallel target compilation</span>
<span class="n">config</span><span class="o">.</span><span class="n">THREADING_LAYER</span> <span class="o">=</span> <span class="s1">&#39;threadsafe&#39;</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">10.</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># this will force the compilation of the function, select a threading layer</span>
<span class="c1"># and then execute in parallel</span>
<span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># demonstrate the threading layer chosen</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Threading layer chosen: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">threading_layer</span><span class="p">())</span>
</pre></div>
</div>
<p>which produces:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Threading</span> <span class="n">layer</span> <span class="n">chosen</span><span class="p">:</span> <span class="n">omp</span>
</pre></div>
</div>
<p>and this makes sense as GNU OpenMP, as present on Linux, is thread safe.</p>
</div>
<div class="section" id="selecting-a-named-threading-layer">
<h3>1.15.2.2. Selecting a named threading layer<a class="headerlink" href="#selecting-a-named-threading-layer" title="Permalink to this headline">¶</a></h3>
<p>Advanced users may wish to select a specific threading layer for their use case,
this is done by directly supplying the threading layer name to the
<a class="reference internal" href="#numba-threading-layer-setting-mech"><span class="std std-ref">setting mechanisms</span></a>. The options
and requirements are as follows:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 14%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Threading Layer Name</p></th>
<th class="head"><p>Platform</p></th>
<th class="head"><p>Requirements</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">tbb</span></code></p></td>
<td><p>All</p></td>
<td><p>The <code class="docutils literal notranslate"><span class="pre">tbb</span></code> package (<code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span> <span class="pre">install</span>
<span class="pre">tbb</span></code>)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">omp</span></code></p></td>
<td><p>Linux</p>
<p>Windows</p>
<p>OSX</p>
</td>
<td><p>GNU OpenMP libraries (very likely this
will already exist)</p>
<p>MS OpenMP libraries (very likely this will
already exist)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">intel-openmp</span></code> package (<code class="docutils literal notranslate"><span class="pre">$</span> <span class="pre">conda</span>
<span class="pre">install</span> <span class="pre">intel-openmp</span></code>)</p>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">workqueue</span></code></p></td>
<td><p>All</p></td>
<td><p>None</p></td>
</tr>
</tbody>
</table>
<p>Should the threading layer not load correctly Numba will detect this and provide
a hint about how to resolve the problem. It should also be noted that the Numba
diagnostic command <code class="docutils literal notranslate"><span class="pre">numba</span> <span class="pre">-s</span></code> has a section
<code class="docutils literal notranslate"><span class="pre">__Threading</span> <span class="pre">Layer</span> <span class="pre">Information__</span></code> that reports on the availability of
threading layers in the current environment.</p>
</div>
</div>
<div class="section" id="extra-notes">
<h2>1.15.3. Extra notes<a class="headerlink" href="#extra-notes" title="Permalink to this headline">¶</a></h2>
<p>The threading layers have fairly complex interactions with CPython internals and
system level libraries, some additional things to note:</p>
<ul class="simple">
<li><p>The installation of Intel’s TBB libraries vastly widens the options available
in the threading layer selection process.</p></li>
<li><p>On Linux, the <code class="docutils literal notranslate"><span class="pre">omp</span></code> threading layer is not fork safe due to the GNU OpenMP
runtime library (<code class="docutils literal notranslate"><span class="pre">libgomp</span></code>) not being fork safe. If a fork occurs in a
program that is using the <code class="docutils literal notranslate"><span class="pre">omp</span></code> threading layer, a detection mechanism is
present that will try and gracefully terminate the forked child and print an
error message to <code class="docutils literal notranslate"><span class="pre">STDERR</span></code>.</p></li>
<li><p>On OSX, the <code class="docutils literal notranslate"><span class="pre">intel-openmp</span></code> package is required to enable the OpenMP based
threading layer.</p></li>
</ul>
</div>
<div class="section" id="setting-the-number-of-threads">
<span id="id1"></span><h2>1.15.4. Setting the Number of Threads<a class="headerlink" href="#setting-the-number-of-threads" title="Permalink to this headline">¶</a></h2>
<p>The number of threads used by numba is based on the number of CPU cores
available (see <a class="reference internal" href="#numba.config.NUMBA_DEFAULT_NUM_THREADS" title="numba.config.NUMBA_DEFAULT_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_DEFAULT_NUM_THREADS</span></code></a>), but it can be
overridden with the <span class="target" id="index-0"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a> environment variable.</p>
<p>The total number of threads that numba launches is in the variable
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a>.</p>
<p>For some use cases, it may be desirable to set the number of threads to a
lower value, so that numba can be used with higher level parallelism.</p>
<p>The number of threads can be set dynamically at runtime using
<a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">numba.set_num_threads()</span></code></a>. Note that <a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_num_threads()</span></code></a> only allows
setting the number of threads to a smaller value than
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a>. Numba always launches
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> threads, but <a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_num_threads()</span></code></a>
causes it to mask out unused threads so they aren’t used in computations.</p>
<p>The current number of threads used by numba can be accessed with
<a class="reference internal" href="#numba.get_num_threads" title="numba.get_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">numba.get_num_threads()</span></code></a>. Both functions work inside of a jitted
function.</p>
<div class="section" id="example-of-limiting-the-number-of-threads">
<span id="numba-threading-layer-thread-masking"></span><h3>1.15.4.1. Example of Limiting the Number of Threads<a class="headerlink" href="#example-of-limiting-the-number-of-threads" title="Permalink to this headline">¶</a></h3>
<p>In this example, suppose the machine we are running on has 8 cores (so
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> would be <code class="docutils literal notranslate"><span class="pre">8</span></code>). Suppose we want to run
some code with <code class="docutils literal notranslate"><span class="pre">&#64;njit(parallel=True)</span></code>, but we also want to run our code
concurrently in 4 different processes. With the default number of threads,
each Python process would run 8 threads, for a total in 4*8 = 32 threads,
which is oversubscription for our 8 cores. We should rather limit each process
to 2 threads, so that the total will be 4*2 = 8, which matches our number of
physical cores.</p>
<p>There are two ways to do this. One is to set the <span class="target" id="index-1"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a>
environment variable to <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nv">NUMBA_NUM_THREADS</span><span class="o">=</span><span class="m">2</span> python ourcode.py
</pre></div>
</div>
<p>However, there are two downsides to this approach:</p>
<ol class="arabic simple">
<li><p><span class="target" id="index-2"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a> must be set before Numba is imported, and
ideally before Python is launched. As soon as Numba is imported the
environment variable is read and that number of threads is locked in as the
number of threads Numba launches.</p></li>
<li><p>If we want to later increase the number of threads used by the process, we
cannot. <span class="target" id="index-3"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a> sets the <em>maximum</em> number of threads
that are launched for a process. Calling <a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_num_threads()</span></code></a> with a
value greater than <a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> results in an
error.</p></li>
</ol>
<p>The advantage of this approach is that we can do it from outside of the
process without changing the code.</p>
<p>Another approach is to use the <a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">numba.set_num_threads()</span></code></a> function in our code</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">njit</span><span class="p">,</span> <span class="n">set_num_threads</span>

<span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="o">...</span>

<span class="n">set_num_threads</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">func</span><span class="p">()</span>
</pre></div>
</div>
<p>If we call <code class="docutils literal notranslate"><span class="pre">set_num_threads(2)</span></code> before executing our parallel code, it has
the same effect as calling the process with <code class="docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS=2</span></code>, in that
the parallel code will only execute on 2 threads. However, we can later call
<code class="docutils literal notranslate"><span class="pre">set_num_threads(8)</span></code> to increase the number of threads back to the default
size. And we do not have to worry about setting it before Numba gets imported.
It only needs to be called before the parallel function is run.</p>
</div>
<div class="section" id="api-reference">
<h3>1.15.4.2. API Reference<a class="headerlink" href="#api-reference" title="Permalink to this headline">¶</a></h3>
<dl class="data">
<dt id="numba.config.NUMBA_NUM_THREADS">
<code class="sig-prename descclassname">numba.config.</code><code class="sig-name descname">NUMBA_NUM_THREADS</code><a class="headerlink" href="#numba.config.NUMBA_NUM_THREADS" title="Permalink to this definition">¶</a></dt>
<dd><p>The total (maximum) number of threads launched by numba.</p>
<p>Defaults to <a class="reference internal" href="#numba.config.NUMBA_DEFAULT_NUM_THREADS" title="numba.config.NUMBA_DEFAULT_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_DEFAULT_NUM_THREADS</span></code></a>, but can be
overridden with the <span class="target" id="index-4"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a> environment variable.</p>
</dd></dl>

<dl class="data">
<dt id="numba.config.NUMBA_DEFAULT_NUM_THREADS">
<code class="sig-prename descclassname">numba.config.</code><code class="sig-name descname">NUMBA_DEFAULT_NUM_THREADS</code><a class="headerlink" href="#numba.config.NUMBA_DEFAULT_NUM_THREADS" title="Permalink to this definition">¶</a></dt>
<dd><p>The number of CPU cores on the system (as determined by
<code class="docutils literal notranslate"><span class="pre">multiprocessing.cpu_count()</span></code>). This is the default value for
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> unless the
<span class="target" id="index-5"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a> environment variable is set.</p>
</dd></dl>

<dl class="function">
<dt id="numba.set_num_threads">
<code class="sig-prename descclassname">numba.</code><code class="sig-name descname">set_num_threads</code><span class="sig-paren">(</span><em class="sig-param">n</em><span class="sig-paren">)</span><a class="headerlink" href="#numba.set_num_threads" title="Permalink to this definition">¶</a></dt>
<dd><p>Set the number of threads to use for parallel execution.</p>
<p>By default, all <a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> threads are used.</p>
<p>This functionality works by masking out threads that are not used.
Therefore, the number of threads <em>n</em> must be less than or equal to
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a>, the total number of threads that are launched.
See its documentation for more details.</p>
<p>This function can be used inside of a jitted function.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>n: The number of threads. Must be between 1 and NUMBA_NUM_THREADS.</strong></dt><dd></dd>
</dl>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="#numba.get_num_threads" title="numba.get_num_threads"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_num_threads</span></code></a>, <a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a></dt><dd></dd>
<dt><a class="reference internal" href="#numba.config.NUMBA_DEFAULT_NUM_THREADS" title="numba.config.NUMBA_DEFAULT_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_DEFAULT_NUM_THREADS</span></code></a>, <span class="target" id="index-6"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a></dt><dd></dd>
</dl>
</div>
</dd></dl>

<dl class="function">
<dt id="numba.get_num_threads">
<code class="sig-prename descclassname">numba.</code><code class="sig-name descname">get_num_threads</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#numba.get_num_threads" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the number of threads used for parallel execution.</p>
<p>By default (if <a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-func docutils literal notranslate"><span class="pre">set_num_threads()</span></code></a> is never called), all
<a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a> threads are used.</p>
<p>This number is less than or equal to the total number of threads that are
launched, <a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a>.</p>
<p>This function can be used inside of a jitted function.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><dl class="simple">
<dt>The number of threads.</dt><dd></dd>
</dl>
</dd>
</dl>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt><a class="reference internal" href="#numba.set_num_threads" title="numba.set_num_threads"><code class="xref py py-obj docutils literal notranslate"><span class="pre">set_num_threads</span></code></a>, <a class="reference internal" href="#numba.config.NUMBA_NUM_THREADS" title="numba.config.NUMBA_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_NUM_THREADS</span></code></a></dt><dd></dd>
<dt><a class="reference internal" href="#numba.config.NUMBA_DEFAULT_NUM_THREADS" title="numba.config.NUMBA_DEFAULT_NUM_THREADS"><code class="xref py py-obj docutils literal notranslate"><span class="pre">numba.config.NUMBA_DEFAULT_NUM_THREADS</span></code></a>, <span class="target" id="index-7"></span><a class="reference internal" href="../reference/envvars.html#envvar-NUMBA_NUM_THREADS"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">NUMBA_NUM_THREADS</span></code></a></dt><dd></dd>
</dl>
</div>
</dd></dl>

</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cli.html" class="btn btn-neutral float-right" title="1.16. Command line interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="performance-tips.html" class="btn btn-neutral float-left" title="1.14. Performance Tips" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2020, Anaconda, Inc. and others

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>