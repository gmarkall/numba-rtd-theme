

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.11. Using the @stencil decorator &mdash; Numba 0.49.0dev0+636.ga4807f5d8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/numba-blue-icon-rgb.svg"/>
  
  
  
    <link rel="canonical" href="http://numba.pydata.org/numba-doc/latest/index.htmluser/stencil.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="1.12. Callback into the Python Interpreter from within JIT’ed code" href="withobjmode.html" />
    <link rel="prev" title="1.10. Automatic parallelization with @jit" href="parallel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Numba
          

          
            
            <img src="../_static/numba-blue-icon-rgb.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.49
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">1. User Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="5minguide.html">1.1. A ~5 minute guide to Numba</a></li>
<li class="toctree-l2"><a class="reference internal" href="overview.html">1.2. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="installing.html">1.3. Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="jit.html">1.4. Compiling Python code with <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="generated-jit.html">1.5. Flexible specializations with <code class="docutils literal notranslate"><span class="pre">&#64;generated_jit</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="vectorize.html">1.6. Creating Numpy universal functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="jitclass.html">1.7. Compiling Python classes with <code class="docutils literal notranslate"><span class="pre">&#64;jitclass</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="cfunc.html">1.8. Creating C callbacks with <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="pycc.html">1.9. Compiling code ahead of time</a></li>
<li class="toctree-l2"><a class="reference internal" href="parallel.html">1.10. Automatic parallelization with <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">1.11. Using the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-usage">1.11.1. Basic usage</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stencil-parameters">1.11.2. Stencil Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kernel-shape-inference-and-border-handling">1.11.3. Kernel shape inference and border handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stencil-decorator-options">1.11.4. Stencil decorator options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#neighborhood">1.11.4.1. <code class="docutils literal notranslate"><span class="pre">neighborhood</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#func-or-mode">1.11.4.2. <code class="docutils literal notranslate"><span class="pre">func_or_mode</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#cval">1.11.4.3. <code class="docutils literal notranslate"><span class="pre">cval</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#standard-indexing">1.11.4.4. <code class="docutils literal notranslate"><span class="pre">standard_indexing</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#stencilfunc">1.11.5. <code class="docutils literal notranslate"><span class="pre">StencilFunc</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#stencil-invocation-options">1.11.6. Stencil invocation options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#out">1.11.6.1. <code class="docutils literal notranslate"><span class="pre">out</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="withobjmode.html">1.12. Callback into the Python Interpreter from within JIT’ed code</a></li>
<li class="toctree-l2"><a class="reference internal" href="jit-module.html">1.13. Automatic module jitting with <code class="docutils literal notranslate"><span class="pre">jit_module</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="performance-tips.html">1.14. Performance Tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="threading-layer.html">1.15. The Threading Layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="cli.html">1.16. Command line interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshoot.html">1.17. Troubleshooting and tips</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html">1.18. Frequently Asked Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">1.19. Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="talks.html">1.20. Talks and Tutorials</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../proposals/index.html">8. Numba Enhancement Proposals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Numba</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">1. User Manual</a> &raquo;</li>
        
      <li>1.11. Using the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/user/stencil.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-the-stencil-decorator">
<span id="numba-stencil"></span><h1>1.11. Using the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator<a class="headerlink" href="#using-the-stencil-decorator" title="Permalink to this headline">¶</a></h1>
<p>Stencils are a common computational pattern in which array elements
are updated according to some fixed pattern called the stencil kernel.
Numba provides the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator so that users may
easily specify a stencil kernel and Numba then generates the looping
code necessary to apply that kernel to some input array.  Thus, the
stencil decorator allows clearer, more concise code and in conjunction
with <a class="reference internal" href="jit.html#parallel-jit-option"><span class="std std-ref">the parallel jit option</span></a> enables higher
performance through parallelization of the stencil execution.</p>
<div class="section" id="basic-usage">
<h2>1.11.1. Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h2>
<p>An example use of the <code class="docutils literal notranslate"><span class="pre">&#64;stencil</span></code> decorator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">stencil</span>

<span class="nd">@stencil</span>
<span class="k">def</span> <span class="nf">kernel1</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<p>The stencil kernel is specified by what looks like a standard Python
function definition but there are different semantics with
respect to array indexing.
Stencils produce an output array of the same size and shape as the
input array although depending on the kernel definition may have a
different type.
Conceptually, the stencil kernel is run once for each element in the
output array.  The return value from the stencil kernel is the value
written into the output array for that particular element.</p>
<p>The parameter <code class="docutils literal notranslate"><span class="pre">a</span></code> represents the input array over which the
kernel is applied.
Indexing into this array takes place with respect to the current element
of the output array being processed.  For example, if element <code class="docutils literal notranslate"><span class="pre">(x,</span> <span class="pre">y)</span></code>
is being processed then <code class="docutils literal notranslate"><span class="pre">a[0,</span> <span class="pre">0]</span></code> in the stencil kernel corresponds to
<code class="docutils literal notranslate"><span class="pre">a[x</span> <span class="pre">+</span> <span class="pre">0,</span> <span class="pre">y</span> <span class="pre">+</span> <span class="pre">0]</span></code> in the input array.  Similarly, <code class="docutils literal notranslate"><span class="pre">a[-1,</span> <span class="pre">1]</span></code> in the stencil
kernel corresponds to <code class="docutils literal notranslate"><span class="pre">a[x</span> <span class="pre">-</span> <span class="pre">1,</span> <span class="pre">y</span> <span class="pre">+</span> <span class="pre">1]</span></code> in the input array.</p>
<p>Depending on the specified kernel, the kernel may not be applicable to the
borders of the output array as this may cause the input array to be
accessed out-of-bounds.  The way in which the stencil decorator handles
this situation is dependent upon which <a class="reference internal" href="#stencil-mode"><span class="std std-ref">func_or_mode</span></a> is selected.
The default mode is for the stencil decorator to set the border elements
of the output array to zero.</p>
<p>To invoke a stencil on an input array, call the stencil as if it were
a regular function and pass the input array as the argument. For example, using
the kernel defined above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">input_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="go">array([[ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9],</span>
<span class="go">       [10, 11, 12, 13, 14, 15, 16, 17, 18, 19],</span>
<span class="go">       [20, 21, 22, 23, 24, 25, 26, 27, 28, 29],</span>
<span class="go">       [30, 31, 32, 33, 34, 35, 36, 37, 38, 39],</span>
<span class="go">       [40, 41, 42, 43, 44, 45, 46, 47, 48, 49],</span>
<span class="go">       [50, 51, 52, 53, 54, 55, 56, 57, 58, 59],</span>
<span class="go">       [60, 61, 62, 63, 64, 65, 66, 67, 68, 69],</span>
<span class="go">       [70, 71, 72, 73, 74, 75, 76, 77, 78, 79],</span>
<span class="go">       [80, 81, 82, 83, 84, 85, 86, 87, 88, 89],</span>
<span class="go">       [90, 91, 92, 93, 94, 95, 96, 97, 98, 99]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">output_arr</span> <span class="o">=</span> <span class="n">kernel1</span><span class="p">(</span><span class="n">input_arr</span><span class="p">)</span>
<span class="go">array([[  0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.],</span>
<span class="go">       [  0.,  11.,  12.,  13.,  14.,  15.,  16.,  17.,  18.,   0.],</span>
<span class="go">       [  0.,  21.,  22.,  23.,  24.,  25.,  26.,  27.,  28.,   0.],</span>
<span class="go">       [  0.,  31.,  32.,  33.,  34.,  35.,  36.,  37.,  38.,   0.],</span>
<span class="go">       [  0.,  41.,  42.,  43.,  44.,  45.,  46.,  47.,  48.,   0.],</span>
<span class="go">       [  0.,  51.,  52.,  53.,  54.,  55.,  56.,  57.,  58.,   0.],</span>
<span class="go">       [  0.,  61.,  62.,  63.,  64.,  65.,  66.,  67.,  68.,   0.],</span>
<span class="go">       [  0.,  71.,  72.,  73.,  74.,  75.,  76.,  77.,  78.,   0.],</span>
<span class="go">       [  0.,  81.,  82.,  83.,  84.,  85.,  86.,  87.,  88.,   0.],</span>
<span class="go">       [  0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.,   0.]])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">input_arr</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">dtype(&#39;int64&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">output_arr</span><span class="o">.</span><span class="n">dtype</span>
<span class="go">dtype(&#39;float64&#39;)</span>
</pre></div>
</div>
<p>Note that the stencil decorator has determined that the output type
of the specified stencil kernel is <code class="docutils literal notranslate"><span class="pre">float64</span></code> and has thus created the
output array as <code class="docutils literal notranslate"><span class="pre">float64</span></code> while the input array is of type <code class="docutils literal notranslate"><span class="pre">int64</span></code>.</p>
</div>
<div class="section" id="stencil-parameters">
<h2>1.11.2. Stencil Parameters<a class="headerlink" href="#stencil-parameters" title="Permalink to this headline">¶</a></h2>
<p>Stencil kernel definitions may take any number of arguments with
the following provisions.  The first argument must be an array.
The size and shape of the output array will be the same as that of the
first argument.  Additional arguments may either be scalars or
arrays.  For array arguments, those arrays must be at least as large
as the first argument (array) in each dimension.  Array indexing is relative for
all such input array arguments.</p>
</div>
<div class="section" id="kernel-shape-inference-and-border-handling">
<span id="stencil-kernel-shape-inference"></span><h2>1.11.3. Kernel shape inference and border handling<a class="headerlink" href="#kernel-shape-inference-and-border-handling" title="Permalink to this headline">¶</a></h2>
<p>In the above example and in most cases, the array indexing in the
stencil kernel will exclusively use <code class="docutils literal notranslate"><span class="pre">Integer</span></code> literals.
In such cases, the stencil decorator is able to analyze the stencil
kernel to determine its size.  In the above example, the stencil
decorator determines that the kernel is <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">x</span> <span class="pre">3</span></code> in shape since indices
<code class="docutils literal notranslate"><span class="pre">-1</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> are used for both the first and second dimensions.  Note that
the stencil decorator also correctly handles non-symmetric and
non-square stencil kernels.</p>
<p>Based on the size of the stencil kernel, the stencil decorator is
able to compute the size of the border in the output array.  If
applying the kernel to some element of input array would cause
an index to be out-of-bounds then that element belongs to the border
of the output array.  In the above example, points <code class="docutils literal notranslate"><span class="pre">-1</span></code> and <code class="docutils literal notranslate"><span class="pre">+1</span></code> are
accessed in each dimension and thus the output array has a border
of size one in all dimensions.</p>
<p>The parallel mode is able to infer kernel indices as constants from
simple expressions if possible. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@njit</span><span class="p">(</span><span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">stencil_test</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">stencil</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="n">c</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">c</span><span class="o">-</span><span class="mi">1</span><span class="p">]))(</span><span class="n">A</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B</span>
</pre></div>
</div>
</div>
<div class="section" id="stencil-decorator-options">
<h2>1.11.4. Stencil decorator options<a class="headerlink" href="#stencil-decorator-options" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The stencil decorator may be augmented in the future to provide additional
mechanisms for border handling. At present, only one behaviour is
implemented, <code class="docutils literal notranslate"><span class="pre">&quot;constant&quot;</span></code> (see <code class="docutils literal notranslate"><span class="pre">func_or_mode</span></code> below for details).</p>
</div>
<div class="section" id="neighborhood">
<span id="stencil-neighborhood"></span><h3>1.11.4.1. <code class="docutils literal notranslate"><span class="pre">neighborhood</span></code><a class="headerlink" href="#neighborhood" title="Permalink to this headline">¶</a></h3>
<p>Sometimes it may be inconvenient to write the stencil kernel
exclusively with <code class="docutils literal notranslate"><span class="pre">Integer</span></code> literals.  For example, let us say we
would like to compute the trailing 30-day moving average of a
time series of data.  One could write
<code class="docutils literal notranslate"><span class="pre">(a[-29]</span> <span class="pre">+</span> <span class="pre">a[-28]</span> <span class="pre">+</span> <span class="pre">...</span> <span class="pre">+</span> <span class="pre">a[-1]</span> <span class="pre">+</span> <span class="pre">a[0])</span> <span class="pre">/</span> <span class="pre">30</span></code> but the stencil
decorator offers a more concise form using the <code class="docutils literal notranslate"><span class="pre">neighborhood</span></code>
option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@stencil</span><span class="p">(</span><span class="n">neighborhood</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="mi">0</span><span class="p">),))</span>
<span class="k">def</span> <span class="nf">kernel2</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="n">cumul</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">29</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">cumul</span> <span class="o">+=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">cumul</span> <span class="o">/</span> <span class="mi">30</span>
</pre></div>
</div>
<p>The neighborhood option is a tuple of tuples.  The outer tuple’s
length is equal to the number of dimensions of the input array.
The inner tuple’s lengths are always two because
each element of the outer tuple corresponds to minimum and
maximum index offsets used in the corresponding dimension.</p>
<p>If a user specifies a neighborhood but the kernel accesses elements outside the
specified neighborhood, <strong>the behavior is undefined.</strong></p>
</div>
<div class="section" id="func-or-mode">
<span id="stencil-mode"></span><h3>1.11.4.2. <code class="docutils literal notranslate"><span class="pre">func_or_mode</span></code><a class="headerlink" href="#func-or-mode" title="Permalink to this headline">¶</a></h3>
<p>The optional <code class="docutils literal notranslate"><span class="pre">func_or_mode</span></code> parameter controls how the border of the output array
is handled.  Currently, there is only one supported value, <code class="docutils literal notranslate"><span class="pre">&quot;constant&quot;</span></code>.
In <code class="docutils literal notranslate"><span class="pre">constant</span></code> mode, the stencil kernel is not applied in cases where
the kernel would access elements outside the valid range of the input
array.  In such cases, those elements in the output array are assigned
to a constant value, as specified by the <code class="docutils literal notranslate"><span class="pre">cval</span></code> parameter.</p>
</div>
<div class="section" id="cval">
<h3>1.11.4.3. <code class="docutils literal notranslate"><span class="pre">cval</span></code><a class="headerlink" href="#cval" title="Permalink to this headline">¶</a></h3>
<p>The optional cval parameter defaults to zero but can be set to any
desired value, which is then used for the border of the output array
if the <code class="docutils literal notranslate"><span class="pre">func_or_mode</span></code> parameter is set to <code class="docutils literal notranslate"><span class="pre">constant</span></code>.  The cval parameter is
ignored in all other modes.  The type of the cval parameter must match
the return type of the stencil kernel.  If the user wishes the output
array to be constructed from a particular type then they should ensure
that the stencil kernel returns that type.</p>
</div>
<div class="section" id="standard-indexing">
<h3>1.11.4.4. <code class="docutils literal notranslate"><span class="pre">standard_indexing</span></code><a class="headerlink" href="#standard-indexing" title="Permalink to this headline">¶</a></h3>
<p>By default, all array accesses in a stencil kernel are processed as
relative indices as described above.  However, sometimes it may be
advantageous to pass an auxiliary array (e.g. an array of weights)
to a stencil kernel and have that array use standard Python indexing
rather than relative indexing.  For this purpose, there is the
stencil decorator option <code class="docutils literal notranslate"><span class="pre">standard_indexing</span></code> whose value is a
collection of strings whose names match those parameters to the
stencil function that are to be accessed with standard Python indexing
rather than relative indexing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@stencil</span><span class="p">(</span><span class="n">standard_indexing</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,))</span>
<span class="k">def</span> <span class="nf">kernel3</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="stencilfunc">
<h2>1.11.5. <code class="docutils literal notranslate"><span class="pre">StencilFunc</span></code><a class="headerlink" href="#stencilfunc" title="Permalink to this headline">¶</a></h2>
<p>The stencil decorator returns a callable object of type <code class="docutils literal notranslate"><span class="pre">StencilFunc</span></code>.
<code class="docutils literal notranslate"><span class="pre">StencilFunc</span></code> objects contains a number of attributes but the only one of
potential interest to users is the <code class="docutils literal notranslate"><span class="pre">neighborhood</span></code> attribute.
If the <code class="docutils literal notranslate"><span class="pre">neighborhood</span></code> option was passed to the stencil decorator then
the provided neighborhood is stored in this attribute.  Else, upon
first execution or compilation, the system calculates the neighborhood
as described above and then stores the computed neighborhood into this
attribute.  A user may then inspect the attribute if they wish to verify
that the calculated neighborhood is correct.</p>
</div>
<div class="section" id="stencil-invocation-options">
<h2>1.11.6. Stencil invocation options<a class="headerlink" href="#stencil-invocation-options" title="Permalink to this headline">¶</a></h2>
<p>Internally, the stencil decorator transforms the specified stencil
kernel into a regular Python function.  This function will have the
same parameters as specified in the stencil kernel definition but will
also include the following optional parameter.</p>
<div class="section" id="out">
<span id="stencil-function-out"></span><h3>1.11.6.1. <code class="docutils literal notranslate"><span class="pre">out</span></code><a class="headerlink" href="#out" title="Permalink to this headline">¶</a></h3>
<p>The optional <code class="docutils literal notranslate"><span class="pre">out</span></code> parameter is added to every stencil function
generated by Numba.  If specified, the <code class="docutils literal notranslate"><span class="pre">out</span></code> parameter tells
Numba that the user is providing their own pre-allocated array
to be used for the output of the stencil.  In this case, the
stencil function will not allocate its own output array.
Users should assure that the return type of the stencil kernel can
be safely cast to the element-type of the user-specified output array
following the <a class="reference external" href="http://docs.scipy.org/doc/numpy/reference/ufuncs.html#casting-rules">Numpy ufunc casting rules</a>.</p>
<p>An example usage is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">input_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">output_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">input_arr</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">kernel1</span><span class="p">(</span><span class="n">input_arr</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">output_arr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="withobjmode.html" class="btn btn-neutral float-right" title="1.12. Callback into the Python Interpreter from within JIT’ed code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="parallel.html" class="btn btn-neutral float-left" title="1.10. Automatic parallelization with @jit" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2020, Anaconda, Inc. and others

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>