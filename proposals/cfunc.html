

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8.2.3. NBEP 4: Defining C callbacks &mdash; Numba 0.49.0dev0+639.ga41f4317f.dirty documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/numba-blue-icon-rgb.svg"/>
  
  
  
    <link rel="canonical" href="http://numba.pydata.org/numba-doc/latest/index.htmlproposals/cfunc.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/rtd-overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8.2.4. NBEP 5: Type Inference" href="type-inference.html" />
    <link rel="prev" title="8.2.2. NBEP 3: JIT Classes" href="jit-classes.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #00A3E0" >
          

          
            <a href="../index.html" class="icon icon-home"> Numba
          

          
            
            <img src="../_static/numba-white-icon-rgb.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.49
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">1. User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">2. Reference Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda/index.html">3. Numba for CUDA GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cuda-reference/index.html">4. CUDA Python Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../roc/index.html">5. Numba for AMD ROC GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extending/index.html">6. Extending Numba</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index.html">7. Developer Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">8. Numba Enhancement Proposals</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#implemented-proposals">8.1. Implemented proposals</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#other-proposals">8.2. Other proposals</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="extension-points.html">8.2.1. NBEP 2: Extension points</a></li>
<li class="toctree-l3"><a class="reference internal" href="jit-classes.html">8.2.2. NBEP 3: JIT Classes</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.2.3. NBEP 4: Defining C callbacks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#basic-usage">8.2.3.1. Basic usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#passing-array-data">8.2.3.2. Passing array data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling">8.2.3.3. Error handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deferred-topics">8.2.3.4. Deferred topics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="type-inference.html">8.2.4. NBEP 5: Type Inference</a></li>
<li class="toctree-l3"><a class="reference internal" href="typing_recursion.html">8.2.5. NBEP 6: Typing Recursion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">9. Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release-notes.html">10. Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Numba</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content style-external-links">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">8. Numba Enhancement Proposals</a> &raquo;</li>
        
      <li>8.2.3. NBEP 4: Defining C callbacks</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/proposals/cfunc.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nbep-4-defining-c-callbacks">
<h1>8.2.3. NBEP 4: Defining C callbacks<a class="headerlink" href="#nbep-4-defining-c-callbacks" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Antoine Pitrou</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>April 2016</p>
</dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd"><p>Draft</p>
</dd>
</dl>
<p>Interfacing with some native libraries (for example written in C
or C++) can necessitate writing native callbacks to provide business logic
to the library.  Some Python-facing libraries may also provide the
alternative of passing a ctypes-wrapped native callback instead of a
Python callback for better performance.  A simple example is the
<code class="docutils literal notranslate"><span class="pre">scipy.integrate</span></code> package where the user passes the function to be
integrated as a callback.</p>
<p>Users of those libraries may want to benefit from the performance advantage
of running purely native code, while writing their code in Python.
This proposal outlines a scheme to provide such a functionality in
Numba.</p>
<div class="section" id="basic-usage">
<h2>8.2.3.1. Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">¶</a></h2>
<p>We propose adding a new decorator, <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code>, importable from the main
package.  This decorator allows defining a callback as in the following
example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cfunc</span>
<span class="kn">from</span> <span class="nn">numba.types</span> <span class="kn">import</span> <span class="n">float64</span>

<span class="c1"># A callback with the C signature `double(double)`</span>

<span class="nd">@cfunc</span><span class="p">(</span><span class="n">float64</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">integrand</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">x</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code> decorator returns a “C function” object holding the
resources necessary to run the given compiled function (for example its
LLVM module).  This object has several attributes and methods:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> attribute is a ctypes function object representing
the native function.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">address</span></code> attribute is the address of the native function code, as
an integer (note this can also be computed from the <code class="docutils literal notranslate"><span class="pre">ctypes</span></code> attribute).</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">native_name</span></code> attribute is the symbol under which the function
can be looked up inside the current process.</p></li>
<li><p>the <code class="docutils literal notranslate"><span class="pre">inspect_llvm()</span></code> method returns the IR for the LLVM module
in which the function is compiled.  It is expected that the <code class="docutils literal notranslate"><span class="pre">native_name</span></code>
attribute corresponds to the function’s name in the LLVM IR.</p></li>
</ul>
<p>The general signature of the decorator is <code class="docutils literal notranslate"><span class="pre">cfunc(signature,</span> <span class="pre">**options)</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">signature</span></code> must specify the argument types and return type of the
function using Numba types.  In contrary to <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code>, the return type cannot
be omitted.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">options</span></code> are keyword-only parameters specifying compilation options.
We are expecting that the standard <code class="docutils literal notranslate"><span class="pre">&#64;jit</span></code> options (<code class="docutils literal notranslate"><span class="pre">nopython</span></code>,
<code class="docutils literal notranslate"><span class="pre">forceobj</span></code>, <code class="docutils literal notranslate"><span class="pre">cache</span></code>) can be made to work with <code class="docutils literal notranslate"><span class="pre">&#64;cfunc</span></code>.</p>
<div class="section" id="calling-from-numba-compiled-functions">
<h3>8.2.3.1.1. Calling from Numba-compiled functions<a class="headerlink" href="#calling-from-numba-compiled-functions" title="Permalink to this headline">¶</a></h3>
<p>While the intended use is to pass a callback’s address to foreign C
code expecting a function pointer, it should be made possible to call
the C callback from a Numba-compiled function.</p>
</div>
</div>
<div class="section" id="passing-array-data">
<h2>8.2.3.2. Passing array data<a class="headerlink" href="#passing-array-data" title="Permalink to this headline">¶</a></h2>
<p>Native platform ABIs as used by C or C++ don’t have the notion of a shaped
array as in Numpy.  One common solution is to pass a raw data pointer and
one or several size arguments (depending on dimensionality).  Numba must
provide a way to rebuild an array view of this data inside the callback.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">cfunc</span><span class="p">,</span> <span class="n">carray</span>
<span class="kn">from</span> <span class="nn">numba.types</span> <span class="kn">import</span> <span class="n">float64</span><span class="p">,</span> <span class="n">CPointer</span><span class="p">,</span> <span class="n">void</span><span class="p">,</span> <span class="n">intp</span>

<span class="c1"># A callback with the C signature `void(double *, double *, size_t)`</span>

<span class="nd">@cfunc</span><span class="p">(</span><span class="n">void</span><span class="p">(</span><span class="n">CPointer</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">CPointer</span><span class="p">(</span><span class="n">float64</span><span class="p">),</span> <span class="n">intp</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="n">out_ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="n">in_</span> <span class="o">=</span> <span class="n">carray</span><span class="p">(</span><span class="n">in_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">carray</span><span class="p">(</span><span class="n">out_ptr</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span><span class="p">,))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">in_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">carray</span></code> function takes <code class="docutils literal notranslate"><span class="pre">(pointer,</span> <span class="pre">shape,</span> <span class="pre">dtype)</span></code> arguments
(<code class="docutils literal notranslate"><span class="pre">dtype</span></code> being optional) and returns a C-layout array view over the
data <em>pointer</em>, with the given <em>shape</em> and <em>dtype</em>.  <em>pointer</em> must
be a ctypes pointer object (not a Python integer).  The array’s
dimensionality corresponds to the <em>shape</em> tuple’s length.  If <em>dtype</em>
is not given, the array’s dtype corresponds to the <em>pointer</em>’s pointee
type.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">farray</span></code> function is similar except that it returns a F-layout
array view.</p>
</div>
<div class="section" id="error-handling">
<h2>8.2.3.3. Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>There is no standard mechanism in C for error reporting.  Unfortunately,
Numba currently doesn’t handle <code class="docutils literal notranslate"><span class="pre">try..except</span></code> blocks, which makes it more
difficult for the user to implement the required error reporting scheme.
The current stance of this proposal is to let users guard against invalid
arguments where necessary, and do whatever is required to inform the caller
of the error.</p>
<p>Based on user feedback, we can later add support for some error reporting
schemes, such as returning an integer error code depending on whether an
exception was raised, or setting <code class="docutils literal notranslate"><span class="pre">errno</span></code>.</p>
</div>
<div class="section" id="deferred-topics">
<h2>8.2.3.4. Deferred topics<a class="headerlink" href="#deferred-topics" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ahead-of-time-compilation">
<h3>8.2.3.4.1. Ahead-of-Time compilation<a class="headerlink" href="#ahead-of-time-compilation" title="Permalink to this headline">¶</a></h3>
<p>This proposal doesn’t make any provision for AOT compilation of C callbacks.
It would probably necessitate a separate API (a new method on the
<code class="docutils literal notranslate"><span class="pre">numba.pycc.CC</span></code> object), and the implementation would require exposing
a subset of the C function object’s functionality from the compiled C
extension module.</p>
</div>
<div class="section" id="opaque-data-pointers">
<h3>8.2.3.4.2. Opaque data pointers<a class="headerlink" href="#opaque-data-pointers" title="Permalink to this headline">¶</a></h3>
<p>Some libraries allow passing an opaque data pointer (<code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>) to a
user-provided callback, to provide any required context for execution
of the callback.  Taking advantage of this functionality would require
adding specific support in Numba, for example the ability to do generic
conversion from <code class="docutils literal notranslate"><span class="pre">types.voidptr</span></code> and to take the address of a
Python-facing <code class="docutils literal notranslate"><span class="pre">jitclass</span></code> instance.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="type-inference.html" class="btn btn-neutral float-right" title="8.2.4. NBEP 5: Type Inference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jit-classes.html" class="btn btn-neutral float-left" title="8.2.2. NBEP 3: JIT Classes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2012-2020, Anaconda, Inc. and others

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>